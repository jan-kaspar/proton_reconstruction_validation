#!/bin/bash

function SubmitOneDir()
{
	local buf="$tag"

	fill=${buf#fill}
	fill=${fill%%_*}

	buf=${buf#*_}
	xangle=${buf%%_*}
	xangle=${xangle#xangle}

	buf=${buf#*_}
	beta=${buf%%_*}
	beta=${beta#beta}

	echo "* $fill, $xangle, $beta"

	# get input
	input="process.source.fileNames.append(\"root://eoscms.cern.ch/${input_dir}/${tag}\")"

	# make work directory
	subdir="fill_$fill/xangle_${xangle}_beta_${beta}_stream_${stream}"
	dir="$top_dir/$subdir"
	mkdir -p "$dir"

	# clean work directory
	rm -rf "$dir/submitted"
	rm -rf "$dir/finished"
	rm -rf "$dir/success"
	rm -rf "$dir/output.root"
	rm -rf "$dir/output_validation.root"
	rm -rf "$dir/output_tracks.root"
	rm -rf "$dir/output_lhcInfo.root"
	rm -rf "$dir/output_optics.root"
	rm -rf "$dir/output_categories.root"
	rm -rf "$dir/output_efficiency.root"
	rm -rf "$dir/log"
	rm -rf "$dir/do_fits.root"

	full_dir="`pwd -P`/$dir"

	# make config
	cat "template_cfg.py" | sed -e "\
			s|\$input|$input|g;\
			s|\$year|$year|g;\
			s|\$fill|$fill|g;\
			s|\$xangle|$xangle|g;\
			s|\$beta|$beta|g;\
			s|\$output|output.root|g;\
			s|\$run_reco|$run_reco|g;\
			s|\$max_events|$max_events|g;\
			s|\$json_file|selection.json|g;\
		" > "$dir/cfg.py"

	# make config with input files
	(
		echo "import FWCore.ParameterSet.Config as cms"
		echo ""
		echo "input_files = cms.untracked.vstring("

		search="fill${fill}_xangle${xangle}_beta${beta}"
		for f_in in `eos ls "$input_dir"|grep ".root"|grep "$search"`
		do
			echo "    \"root://eostotem.cern.ch/${input_dir}/${f_in}\","
		done

		echo ")"
	) > "$dir/input_files.py"

	# make job
	cat "template_job" | sed "\
			s|\$sw_dir|$sw_dir|g;\
			s|\$job_dir|$full_dir|g;\
		" > "$dir/job"
	chmod u+x "$dir/job"

	# copy json file
	cp "json/cms_pps_$year.json" "$dir/selection.json"

	# add submission line
	(
		echo ""
		echo "dir=$subdir"
		echo "queue"
	) >> "$condor_file_sub"

	# local run
	# TODO
	#cd "$dir"
	#cmsRun "cfg.py" &
	#cd - &> /dev/null
}

#----------------------------------------------------------------------------------------------------

function Submit()
{
	top_dir="data/$year/$version"

	mkdir -p "$top_dir"

	condor_file_sub="$top_dir/condor.sub"

	# initiate submission script
	(
		local base_dir_full="$(pwd)/$top_dir"
		echo "executable = $base_dir_full/\$(dir)/job"
		echo "arguments = \$(ClusterId) \$(ProcId) \\\"\$(dir)\\\""
		echo "output = $base_dir_full/\$(dir)/out"
		echo "error = $base_dir_full/\$(dir)/err"
		echo "log = $base_dir_full/condor_${selection}.log"

		echo "+MaxRuntime = 10800"
		#echo "+JobBatchName = \"$job_name\""
		#echo "requirements = (OpSysAndVer =?= \"SLCern6\")"
		echo "requirements = (OpSysAndVer =?= \"CentOS7\")"

	) > "$condor_file_sub"

	# loop over input files
	for tag in `eos ls "$input_dir"|grep .root|sed "s/_[a-zA-Z]*\.root//"|sort|uniq`
	do
		SubmitOneDir
	done

	# submit
	echo "In order to submit do:"
	echo "    condor_submit \"$condor_file_sub"\"
	#condor_submit "$condor_file_sub"
}

#----------------------------------------------------------------------------------------------------

# defaults

run_reco="True"
max_events="4000000"

#----------------------------------------------------------------------------------------------------

year="2016"
#stream="SingleMuon"
#stream="ZeroBias"
stream="ALL"

#version="version5"
#input_dir="/eos/cms/store/group/phys_pps/reconstruction/2016/physics_runs/rec-hit-version1"
#sw_dir="/afs/cern.ch/work/j/jkaspar/work/software/ctpps/development/proton_reco_step4/CMSSW_10_6_1/src"
# at f2e490a377efd0fc22deee052cfbb8683747a039 (Switched to version2 of 2016 pre-TS2 optics)
# with GT 106X_dataRun2_v11, local alignment
#Submit

#version="version6"
#input_dir="/eos/cms/store/group/phys_pps/reconstruction/2016/physics_runs/rec-hit-version1"
#sw_dir="/afs/cern.ch/work/j/jkaspar/work/software/ctpps/development/proton_reco_step4/CMSSW_10_6_1/src"
## at e5ae42006066be39938358106d921031eac4c0a4
## with GT 106X_dataRun2_v26, alignment local, optics local
##Submit

#version="version-UL-2"
#input_dir="/eos/cms/store/group/phys_pps/reconstruction/2016/physics_runs/version-UL-2"
#sw_dir="/afs/cern.ch/work/j/jkaspar/work/software/ctpps/development/jan_buffer_10_6/CMSSW_10_6_11_CANDIDATE2/src"
## at 0391ee8cff4
## with GT 106X_dataRun2_v26
#run_reco="False"
## this repo at 0d3c1eb
##Submit

#version="version-UL-4"
#input_dir="/eos/cms/store/group/phys_pps/reconstruction/2016/physics_runs/version-UL-2"
#sw_dir="/afs/cern.ch/work/j/jkaspar/work/software/ctpps/development/jan_buffer_10_6/CMSSW_10_6_11_CANDIDATE2/src"
## at 57f24476748
## with GT 106X_dataRun2_v26
#run_reco="False"
## this repo at 58ba45b
#Submit

version="version-UL-5"
input_dir="/eos/cms/store/group/phys_pps/reconstruction/2016/physics_runs/version-UL-2"
sw_dir="/afs/cern.ch/work/j/jkaspar/work/software/ctpps/development/jan_buffer_10_6/CMSSW_10_6_11_CANDIDATE2/src"
# at 57f24476748
# with GT 106X_dataRun2_v26
run_reco="False"
# this repo at 69da062
Submit

#----------------------------------------------------------------------------------------------------

year="2017"
#stream="DoubleEG"
stream="ALL"

#version="version13"
#input_dir="/eos/cms/store/group/phys_pps/reconstruction/2017/physics_runs/rec-hit-version2"
#sw_dir="/afs/cern.ch/work/j/jkaspar/work/software/ctpps/development/proton_reco_step4/CMSSW_10_6_1/src"
# at e5ae42006066be39938358106d921031eac4c0a4
# with GT 106X_dataRun2_v26, alignment local, optics local
#Submit

#version="version14"
#input_dir="/eos/cms/store/group/phys_pps/reconstruction/2017/physics_runs/rec-hit-version2"
#sw_dir="/afs/cern.ch/work/j/jkaspar/work/software/ctpps/development/proton_reco_step4/CMSSW_10_6_1/src"
## at 0ef1dff8b20
## with GT 106X_dataRun2_v26, alignment local, optics local
##Submit

#version="version-UL-1"
#input_dir="/eos/cms/store/group/phys_pps/reconstruction/2017/physics_runs/version-UL-1"
#sw_dir="/afs/cern.ch/work/j/jkaspar/work/software/ctpps/development/jan_buffer_10_6/CMSSW_10_6_11_CANDIDATE2/src"
#run_reco="False"
## at b26e5481c6c
## with GT 106X_dataRun2_v26
##Submit

#version="version-UL-2"
#input_dir="/eos/cms/store/group/phys_pps/reconstruction/2017/physics_runs/version-UL-2"
#sw_dir="/afs/cern.ch/work/j/jkaspar/work/software/ctpps/development/jan_buffer_10_6/CMSSW_10_6_11_CANDIDATE2/src"
## at 0391ee8cff4
## with GT 106X_dataRun2_v26
#run_reco="False"
## this repo at 0d3c1eb
##Submit

#version="version-UL-4"
#input_dir="/eos/cms/store/group/phys_pps/reconstruction/2017/physics_runs/version-UL-2"
#sw_dir="/afs/cern.ch/work/j/jkaspar/work/software/ctpps/development/jan_buffer_10_6/CMSSW_10_6_11_CANDIDATE2/src"
## at 57f24476748
## with GT 106X_dataRun2_v26
#run_reco="False"
## this repo at 58ba45b
##Submit

version="version-UL-5"
input_dir="/eos/cms/store/group/phys_pps/reconstruction/2017/physics_runs/version-UL-2"
sw_dir="/afs/cern.ch/work/j/jkaspar/work/software/ctpps/development/jan_buffer_10_6/CMSSW_10_6_11_CANDIDATE2/src"
# at 57f24476748
# with GT 106X_dataRun2_v26
run_reco="False"
# this repo at 69da062
Submit

version="version-UL-4"
input_dir="/eos/cms/store/group/phys_pps/reconstruction/2017/physics_runs/version-UL-2"
sw_dir="/afs/cern.ch/work/j/jkaspar/work/software/ctpps/development/jan_buffer_10_6/CMSSW_10_6_11_CANDIDATE2/src"
# at 57f24476748
# with GT 106X_dataRun2_v26
run_reco="False"
# this repo at 58ba45b
#Submit

version="version-UL-retune-3" # 2017: discard BX-shifted tracks, add th*_y rule for near-far association cuts
input_dir="/eos/cms/store/group/phys_pps/reconstruction/2017/physics_runs/version-UL-2"
sw_dir="/afs/cern.ch/work/j/jkaspar/work/software/ctpps/development/jan_buffer_10_6/CMSSW_10_6_11_CANDIDATE2/src"
# at b89c9969f6b
# with GT 106X_dataRun2_v26
run_reco="True"
# this repo at TODO
#Submit

#----------------------------------------------------------------------------------------------------

year="2018"
#stream="SingleMuon"
stream="ALL"

#version="version11"
#input_dir="/eos/cms/store/group/phys_pps/reconstruction/2018/physics_runs/rec-hit-version1"
#sw_dir="/afs/cern.ch/work/j/jkaspar/work/software/ctpps/development/proton_reco_step4/CMSSW_10_6_1/src"
# at e5ae42006066be39938358106d921031eac4c0a4
# with GT 106X_dataRun2_v26, alignment local, optics local
#Submit

#version="version12"
#input_dir="/eos/cms/store/group/phys_pps/reconstruction/2018/physics_runs/rec-hit-version1"
#sw_dir="/afs/cern.ch/work/j/jkaspar/work/software/ctpps/development/proton_reco_step4/CMSSW_10_6_1/src"
# at ???
# with GT 106X_dataRun2_v26, alignment local, optics local
#Submit

#version="version13"
#input_dir="/eos/cms/store/group/phys_pps/reconstruction/2018/physics_runs/rec-hit-version1"
#sw_dir="/afs/cern.ch/work/j/jkaspar/work/software/ctpps/development/proton_reco_step4/CMSSW_10_6_1/src"
## at 7bfb981d843
## with GT 106X_dataRun2_v26, alignment local (test version!), optics local
##Submit

#version="version-UL-1"
#input_dir="/eos/cms/store/group/phys_pps/reconstruction/2018/physics_runs/version-UL-1"
#sw_dir="/afs/cern.ch/work/j/jkaspar/work/software/ctpps/development/jan_buffer_10_6/CMSSW_10_6_11_CANDIDATE2/src"
## at b26e5481c6c
## with GT 106X_dataRun2_v26
#run_reco="False"
#max_events="-1"
#Submit

#version="version-UL-2"
#input_dir="/eos/cms/store/group/phys_pps/reconstruction/2018/physics_runs/version-UL-2"
#sw_dir="/afs/cern.ch/work/j/jkaspar/work/software/ctpps/development/jan_buffer_10_6/CMSSW_10_6_11_CANDIDATE2/src"
## at 0391ee8cff4
## with GT 106X_dataRun2_v26
#run_reco="False"
## this repo at 0d3c1eb
#Submit

#version="version-UL-4"
#input_dir="/eos/cms/store/group/phys_pps/reconstruction/2018/physics_runs/version-UL-2"
#sw_dir="/afs/cern.ch/work/j/jkaspar/work/software/ctpps/development/jan_buffer_10_6/CMSSW_10_6_11_CANDIDATE2/src"
## at 57f24476748
## with GT 106X_dataRun2_v26
#run_reco="False"
## this repo at 58ba45b
##Submit

version="version-UL-5"
input_dir="/eos/cms/store/group/phys_pps/reconstruction/2018/physics_runs/version-UL-2"
sw_dir="/afs/cern.ch/work/j/jkaspar/work/software/ctpps/development/jan_buffer_10_6/CMSSW_10_6_11_CANDIDATE2/src"
# at 57f24476748
# with GT 106X_dataRun2_v26
run_reco="False"
# this repo at 69da062
Submit

version="version-UL-retune-1" # retuned D_y 
input_dir="/eos/cms/store/group/phys_pps/reconstruction/2018/physics_runs/version-UL-2"
sw_dir="/afs/cern.ch/work/j/jkaspar/work/software/ctpps/development/jan_buffer_10_6/CMSSW_10_6_11_CANDIDATE2/src"
# at TODO
# with GT 106X_dataRun2_v26
run_reco="True"
# this repo at TODO
#Submit

version="version-UL-retune-2" # retuned alignment
input_dir="/eos/cms/store/group/phys_pps/reconstruction/2018/physics_runs/version-UL-2"
sw_dir="/afs/cern.ch/work/j/jkaspar/work/software/ctpps/development/jan_buffer_10_6/CMSSW_10_6_11_CANDIDATE2/src"
# at TODO + test alignment
# with GT 106X_dataRun2_v26, local alignment
run_reco="True"
# this repo at TODO
#Submit
